/*! 版权所有，翻版必究 */!function(s){function e(e){for(var t,n,o=e[0],a=e[1],i=e[2],r=0,d=[];r<o.length;r++)n=o[r],Object.prototype.hasOwnProperty.call(u,n)&&u[n]&&d.push(u[n][0]),u[n]=0;for(t in a)Object.prototype.hasOwnProperty.call(a,t)&&(s[t]=a[t]);for(m&&m(e);d.length;)d.shift()();return l.push.apply(l,i||[]),c()}function c(){for(var e,t=0;t<l.length;t++){for(var n=l[t],o=!0,a=1;a<n.length;a++){var i=n[a];0!==u[i]&&(o=!1)}o&&(l.splice(t--,1),e=r(r.s=n[0]))}return e}var n={},u={23:0},l=[];function r(e){if(n[e])return n[e].exports;var t=n[e]={i:e,l:!1,exports:{}};return s[e].call(t.exports,t,t.exports,r),t.l=!0,t.exports}r.m=s,r.c=n,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)r.d(n,o,function(e){return t[e]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="";var t=window.webpackJsonp=window.webpackJsonp||[],o=t.push.bind(t);t.push=e,t=t.slice();for(var a=0;a<t.length;a++)e(t[a]);var m=o;l.push([141,0]),c()}({141:function(e,t,n){"use strict";n.r(t);t=n(396),t=n(398);layui.use(["laydate","table","tree","flow","layer","form"],function(){var t="",n="",e=layui.laydate;e.render({elem:"#test6",range:!0,done:function(e){e=e.split(" - ");t=e[0],n=e[1]}}),$(".sidebar i").click(function(){$(".data-left").hide(),$(".onLeft").show()}),$(".onLeft").click(function(){$(".onLeft").hide(),$(".data-left").show()});var o,a,i=sessionStorage.token,r=layui.tree,d=layui.flow,s=layui.layer,c=layui.table,u=layui.form,l=c.render({elem:"#moneyData",url:"".concat(vApi,"/order/getOrderList"),method:"post",contentType:"application/json",headers:{token:i},cols:[[{field:"info",width:210,title:"终端名",align:"center"},{field:"number",width:180,title:"订单编号",align:"center"},{field:"number",width:130,title:"订单金额",align:"center",templet:function(e){var t=0;return 0!=e.goodsList.length?(e.goodsList.forEach(function(e){t+=e.price}),t):0}},{field:"payStatus",width:130,align:"center",title:"支付状态",templet:function(e){return 1==e.payStatus?"等待支付":2==e.payStatus?"已支付":"未支付"}},{field:"time",width:180,title:"支付时间",align:"center",templet:function(e){return e.time?timeStamp(e.time):"-"}},{field:"bili",width:160,align:"center",title:"支付类型",templet:function(e){return 1==e.payType?"微信":0==e.payType?"支付宝":"工行支付"}},{field:"sign_name",width:210,title:"退款状态",align:"center",templet:function(e){var t=0,n=0;return e.goodsList.forEach(function(e){t+=e.count,n+=e.refund_count}),0==n?"未退款":t-n==0?"全部退款":"部分退款"}},{field:"shipStatus",width:210,title:"出货状态",align:"center",templet:function(e){return 0==e.shipStatus?"未出货":1==e.shipStatus?"部分出货失败":"全部出货成功"}},{field:"ship_info",width:200,title:"出货详情",align:"center",templet:function(e){if(0==e.ship_info.length)return"-";var n="";return e.ship_info.forEach(function(e,t){n+="<div>".concat(e.goods_Name,"(").concat(e.way,"货道").concat(0==e.ship_status?"出货失败":1==e.ship_status?"出货成功":"货道故障",")</div>")}),n}},{field:"sales_no",width:160,title:"销售经理",align:"center",templet:function(e){return e.sales_no||"-"}},{field:"payee",width:160,title:"收款方",align:"center"},{field:"operation",width:110,title:"详情 ",toolbar:"#barDemo",align:"center"}]],page:!0,loading:!0,request:{pageName:"pageNum",limitName:"pageSize"},where:{conditionFive:sessionStorage.machineID,conditionSeven:0},parseData:function(e){return 200==e.code?{code:e.code,msg:e.message,count:e.data.total,data:e.data.list}:403!=e.code?{code:e.code,msg:e.message}:void(window.parent.location.href="login.html")},response:{statusCode:200},done:function(e){var n,o,a,i;200==e.code?(console.log(e),i=a=o=n=0,$('.ban-input input[name="orderNumVal"]').val(e.data.length),e.data.forEach(function(e,t){1==e.payStatus&&(n+=e.amount,e.goodsList.forEach(function(e,t){o+=(e.price-e.goods_Cost)*(e.count-e.refund_count),a+=e.price*(e.count-e.refund_count),i+=e.price*e.refund_count}))}),$('.ban-input input[name="orderAllSumVal"]').val(numFormat1(n)),$('.ban-input input[name="profitsSum"]').val(numFormat1(o)),$('.ban-input input[name="orderPaidInSum"]').val(numFormat1(a)),$('.ban-input input[name="orderRefundSum"]').val(numFormat1(i))):405==e.code&&$(".hangContent").show()}}),m=" ",p=sessionStorage.machineID,i=treeList(m);function f(){d.load({elem:"#demo",isAuto:!0,scrollElem:"#demo",end:" ",done:function(t,o){setTimeout(function(){var n=[];o(n.join(""),t<3);var e=JSON.stringify({pageNum:t,pageSize:10,merchantId:p});loadingAjax("/machine/getMachineList","post",e,sessionStorage.token).then(function(e){e.data.list.forEach(function(e,t){n.push('<span machineID="'.concat(e.machineId,'">').concat(e.info||"未命名售货机","</span>"))}),o(n.join(""),10<=e.data.list)}).catch(function(e){console.log(e),s.msg(e.message,{icon:7}),o(n.join(""),200==e.code)})},200)}})}m=sessionStorage.marchantName,o="test1",a=i,r.render({elem:"#".concat(o),id:"treelist",showLine:!0,onlyIconControl:!0,data:a,spread:!0,text:{defaultNodeName:"无数据",none:"您没有权限，请联系管理员授权!"},click:function(e){console.log(e),m=e.data.title;for(var t=$("#".concat(o," .layui-tree-txt")),n=0;n<t.length;n++)t[n].innerHTML===e.data.title?t[n].style.color="#be954a":t[n].style.color="#555";p!=e.data.id&&(p=e.data.id,$("#demo").remove(),$(document).unbind(),$(".equipment").append('<div class="machineList" id="demo"></div>'),f(),$(".allmachine").addClass("active"),$(".machineList span").removeClass("active"),h="",l.reload({where:{conditionFour:h,conditionFive:p}}))}}),f();var h="";$("body").on("click",".machineList span",function(){$(".allmachine").removeClass("active"),$(this).addClass("active").siblings().removeClass("active"),h=$(this).attr("machineID"),l.reload({where:{conditionFour:h}})}),$(".allmachine").click(function(){$(this).addClass("active"),$(".machineList span").removeClass("active"),h="",l.reload({where:{conditionFour:h}})});var g=null,y=null;e.render({elem:"#test8",type:"month",range:!0,done:function(e){e=e.split(" - ");g=e[0],y=e[1]}}),$(".pushBtn").click(function(){$(".exportBody p").html(m+"订单表格"),popupShow("exportCont","exportBox")}),$(".playHeader .close").click(function(){$(this).parent().parent().addClass("margin0"),$(this).parents(".maskContnet").fadeOut()}),$(".exportCont .cancelBtn").click(function(){popupHide("exportCont","exportBox")}),$(".exportCont .determinePushBtn").click(function(){var a,e;g&&y?($(".mask").fadeIn(),$(".maskSpan").addClass("maskIcon"),new Date,(a=new XMLHttpRequest).open("POST","".concat(vApi,"/order/exportExcel"),!0),a.setRequestHeader("token",sessionStorage.token),a.setRequestHeader("Content-Type","application/json;charset=utf-8"),a.responseType="blob",a.onload=function(e){var t,n,o;console.log(a),200==a.status?($(".mask").fadeOut(),$(".maskSpan").removeClass("maskIcon"),o=a.response,t="".concat(m,"订单(").concat(g,"-").concat(y,").xlsx"),(n=document.createElement("a")).download=t,n.style.display="none",o=new Blob([o]),n.href=URL.createObjectURL(o),document.body.appendChild(n),n.click(),document.body.removeChild(n)):($(".mask").fadeOut(),$(".maskSpan").removeClass("maskIcon"),s.msg("服务器请求超时",{icon:2}))},e=JSON.stringify({start_time:g,end_time:y,merchantId:p}),a.send(e)):s.msg("请选择时间",{icon:7})});var v=null;var b=null;c.on("row(moneyData)",function(e){console.log(e),b=e.data,v=v||c.render({elem:"#GooodsData",cols:[[{field:"goods_images",width:120,title:"图片",templet:"#imgtmp",align:"center"},{field:"goods_Name",width:140,title:"商品名",align:"center"},{field:"goods_Core",width:140,title:"商品编号",align:"center"},{field:"count",width:120,title:"购买数量",align:"center"},{field:"refund_count",width:120,title:"已退款数量",align:"center"},{field:"price",width:140,title:"销售价 ",align:"center"},{field:"goods_Cost",width:140,title:"成本价 ",align:"center"},{field:"operation",right:0,width:80,align:"center",title:"操作",toolbar:"#refundDemo",fixed:"right"}]],data:[],id:"goodsLIstTable",loading:!0,done:function(e){for(var t in e.data.forEach(function(e){e.goods_Price}),I(),e.data){1==e.data[t].refund&&($(".goodsListBody tr[data-index="+t+'] input[type="checkbox"]').prop("disabled",!0),u.render())}}}),$(".detailsOrderCode").html(e.data.number),$(".payTime").html(timeStamp(e.data.time)),$(".orderInformation button span").html(0==e.data.shipStatus?"未出货":1==e.data.shipStatus?"部分出货失败":"出货成功");var n=0,o=0,a=0,i=0,r=0;e.data.goodsList.forEach(function(e,t){n+=e.count,o+=e.price*(e.count-e.refund_count),r+=e.price*e.count,a+=(100*e.price-100*e.goods_Cost)*(e.count-e.refund_count),i+=e.price*e.refund_count}),$(".payType").html(0==e.data.payStatus?"支付宝":1==e.data.payStatus?"微信":"工行支付"),$(".payNUmber").html(n),$(".paidInSum").html(2==e.data.payStatus?"￥"+o:"￥0"),$(".orderSum").html("￥"+r),$(".profitsSum").html("￥"+a/100),$(".collection button span").html(1==e.data.payStatus?"等待支付":2==e.data.payStatus?"支付成功":"未支付"),$(".machineCode").html(e.data.machineId),$(".merchantName").html(e.data.merchantName),$(".merchantCode ").html(e.data.alias),$(".refundSum").html("￥"+i),popupShow("orderDetails","orderDetailsBox"),v.reload({data:e.data.goodsList})}),$(".queryBtn").click(function(){l.reload({where:{condition:t,conditionTwo:n,conditionThree:$('.key-contnet input[name="orderCode"]').val()}})}),$(".refreshBtn").click(function(){location.reload()}),$("body").bind("keydown",function(e){116==e.keyCode&&f5Fun()});var w=null;c.on("tool(GooodsData)",function(e){2==b.payStatus?(w=e.data,console.log(w),e.data.count!=e.data.refund_count?($(".twoPoles span").html(e.data.count-e.data.refund_count),$(".refundNumber input").val(1),$(".refundNumber input").prop("max",e.data.count-e.data.refund_count),$('.sumInput input[name="sum"]').val(w.price),popupShow("refundNUmCont","refundBox")):s.msg("该商品已全部退款",{icon:7})):s.msg("订单未支付，不能进行退款操作",{icon:7})}),$(".refundNUmCont .chooseCan").click(function(){popupHide("refundNUmCont","refundBox")}),$(".refundNUmCont .determineBtn").click(function(){console.log($(".refundNumber input").val()),0<$(".refundNumber input").val()&&$(".refundNumber input").val()<=w.count-w.refund_count?s.confirm("确定退款？",function(e){var t;s.close(e),$(".mask").fadeIn(),$(".maskSpan").addClass("maskIcon"),0==b.payType?(t=JSON.stringify({machineId:b.machineId,orderId:b.number,goodId:w.goods_Id,count:Number($(".refundNumber input").val()),amount:Number($('.sumInput input[name="sum"]').val()),pay_id:b.pay_id}),loadingAjax("/pay/refund_alipay","post",t,sessionStorage.token,"mask","refundNUmCont","refundBox",s).then(function(e){s.msg(e.message,{icon:1}),popupHide("orderDetails","orderDetailsBox"),l.reload({where:{}})}).catch(function(e){s.msg(e.message,{icon:2})})):1==b.payType?(t=JSON.stringify({machineId:b.machineId,orderId:b.number,goodId:w.goods_Id,count:Number($(".refundNumber input").val()),amount:Number($('.sumInput input[name="sum"]').val()),transaction_id:b.transaction_id,total:b.amount,pay_id:b.pay_id}),loadingAjax("/pay/refund_wxpay","post",t,sessionStorage.token,"mask","refundNUmCont","refundBox").then(function(e){s.msg(e.message,{icon:1}),popupHide("orderDetails","orderDetailsBox"),l.reload({where:{}})}).catch(function(e){s.msg(e.message,{icon:2})})):3==b.payType&&(t=JSON.stringify({machineId:b.machineId,orderId:b.number,goodId:w.goods_Id,count:Number($(".refundNumber input").val()),transaction_id:b.transaction_id,amount:Number($('.sumInput input[name="sum"]').val()),pay_id:b.pay_id}),loadingAjax("/pay/refund_icbc","post",t,sessionStorage.token,"mask","refundNUmCont","refundBox").then(function(e){s.msg(e.message,{icon:1}),popupHide("orderDetails","orderDetailsBox"),l.reload({where:{}})}).catch(function(e){s.msg(e.message,{icon:2})}))}):s.msg("请按照提示填写数量",{icon:7})});var S=1;$(".refundNumber input").keyup(function(){var e=$(this).val();/^\d*$/.test(e)?(S=$(this).val(),console.log(S)):(s.msg("只能输入正整数",{icon:7}),$(this).val(S)),$('.sumInput input[name="sum"]').val(Number($(this).val()*w.price)),$('.sumInput input[name="sum"]').val(Number($(this).val()*w.price))}),$(".refundNumber input").change(function(){$('.sumInput input[name="sum"]').val(Number($(this).val()*w.price))}),$(".orderDetails .refundBtn").click(function(){s.confirm("确定退款？(请检查订单出货情况！)",function(e){s.close(e),$(".mask").fadeIn(),$(".maskSpan").addClass("maskIcon");var t=[];b.goodsList.forEach(function(e){t.push(e.goods_Id)});var n=JSON.stringify({machineId:b.machineId,orderId:b.number,amount:.01,goodId:t,transaction_id:1==b.payType?b.transaction_id:"",total:1==b.payType?Number(b.amount):""}),e="";0==b.payType?e="".concat(vApi,"/pay/refund_alipay"):1==b.payType&&(e="".concat(vApi,"/pay/refund_wxpay")),loadingAjax(e,"post",n,sessionStorage.token,"mask","orderDetails ","orderDetailsBox",s).then(function(e){s.msg(e.message,{icon:1}),l.reload({where:{}})}).catch(function(e){s.msg(e.message,{icon:2})})})});var _=!1,k=!1;function I(){_?$(".pushBtn").removeClass("hide"):$(".pushBtn").addClass("hide"),k?$(".refundBtnTwo").removeClass("hide"):$(".refundBtnTwo").addClass("hide")}permissionsVal(420,421).then(function(e){_=e.addFlag,k=e.editFlag,I()}).catch(function(e){s.msg("服务器请求超时",{icon:7})})})},396:function(e,t){},398:function(e,t){}});